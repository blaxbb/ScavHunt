@page "/admin/players/{BadgeNumber}"
@attribute [Authorize]

@using ScavHunt.Data.Models
@inject PlayerAdminService players
@inject PointAdminService points
@inject NavigationManager nav
@inject JSInterop js
@inject AuthenticationStateProvider auth
@inject LogAdminService log

<Modal Id="addPoints" Title="Add Points">
    <form class="px-3" @onsubmit="(async() => await SubmitManualPoints())">
        <div class="mb-3 row">
            <label class="col-form-label col-sm-3">Points</label>
            <input class="form-input col-sm-9" type="number" step="1" @bind-value="manualPoints"/>
        </div>
        <div class="mb-3 row">
            <label class="col-form-label col-sm-3">Message</label>
            <input class="form-input col-sm-9" @bind-value="manualPointsMessage"/>
        </div>
        <div class="mb-3 row">
            <button class="btn btn-primary col" type="submit">Submit</button>
        </div>
    </form>
</Modal>

<Modal Id="logMessage" Title="Log Message">
    <form class="px-3" @onsubmit="(async() => await SumbitMessage())">
        <div class="mb-3 row">
            <label class="col-form-label col-sm-3">Message</label>
            <input class="form-input col-sm-9" @bind-value="logMessage"/>
        </div>
        <div class="mb-3 row">
            <button class="btn btn-primary col" type="submit">Submit</button>
        </div>
    </form>
</Modal>

<Modal Id="resetQuestion" Title="Reset Question">
    <form class="px-3" @onsubmit="(async() => ConfirmResetQuestion())">
        <div class="mb-3 row">
            This will reset progress on question @resetQuestion?.ShortCode for player with badge number @player.BadgeNumber.
        </div>
        <div class="mb-3 row">
            This should not be done unless deemed necessary due to game malfunction.
        </div>
        <div class="mb-3 row">
            <label class="col-form-label col-sm-3">Message</label>
            <input class="form-input col-sm-9" @bind-value="resetMessage"/>
        </div>
        <div class="mb-3 row">
            <button class="btn btn-danger col" type="submit">Reset</button>
        </div>
    </form>
</Modal>

@if(player == default)
{
    <div class="container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="container">
        <div class="row card mb-3">
            <div class="card-header">
                <h3 class="text-center my-1">Info</h3>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-lg-3">Badge Number</dt>
                    <dd class="col-lg-9">@player.BadgeNumber</dd>
                    <dt class="col-lg-3">Points</dt>
                    <dd class="col-lg-9">@player.PointTransactions.Sum(p => p.Value)</dd>
                </dl>
            </div>
        </div>
        <div class="row card mb-3">
            <div class="card-header row m-0">
                <div class="col">
                    <h3 class="text-center my-1">Points</h3>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-outline-primary" @onclick="@(async () => await js.ShowModal("addPoints"))">+</button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <td>Source</td>
                            <td>Question</td>
                            <td>Value</td>
                            <td>Timestamp</td>
                            <td></td>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var transaction in player.PointTransactions.OrderByDescending(p => p.Timestamp))
                        {
                            <tr>
                                <td>@transaction.Source</td>
                                <td>@(transaction.Question?.ShortCode ?? "")</td>
                                <td>@transaction.Value</td>
                                <td>@transaction.Timestamp</td>
                                <td>
                                    @if(transaction.Source == PointTransaction.PointSource.Question && transaction.Question != default)
                                    {
                                        <button type="button" class="btn btn-primary" @onclick="(async () => await ResetQuestion(transaction.Question))"><span class="oi oi-trash"></span></button>
                                    }
                                    else
                                    {
                                        
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row card mb-3">
            <div class="card-header row m-0">
                <div class="col">
                    <h3 class="text-center my-1">Logs</h3>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-outline-primary" @onclick="@(async () => await js.ShowModal("logMessage"))">+</button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <td>Type</td>
                            <td>Message</td>
                            <td>Question</td>
                            <td>Timestamp</td>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var log in player.Responses.OrderByDescending(l => l.Timestamp))
                        {
                            <tr>
                                <td>@log.Type</td>
                                <td>@log.Message</td>
                                <td>@log.Question?.ShortCode</td>
                                <td>@log.Timestamp</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    Player? player { get; set; }

    [Parameter]
    public string? BadgeNumber { get; set; }

    string? manualPoints { get; set; }
    string? manualPointsMessage { get; set; }

    string? logMessage { get; set; }

    Question? resetQuestion { get; set; }
    string? resetMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(BadgeNumber))
        {
            nav.NavigateTo("404");
            return;
        }

        player = players.GetFromBadge(BadgeNumber);

        if (player == default)
        {
            nav.NavigateTo("404");
            return;
        }
    }

    async Task SubmitManualPoints()
    {
        int p = 0;

        if(!int.TryParse(manualPoints, out p))
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(manualPointsMessage))
        {
            return;
        }

        if(player == default)
        {
            return;
        }

        var account = await auth.GetAuthenticationStateAsync();
        var adminName = account?.User?.Identity?.Name;
        if(adminName == default)
        {
            return;
        }

        await points.AddPoints(new PointTransaction()
        {
            Player = player,
            Source = PointTransaction.PointSource.Manual,
            Timestamp = DateTime.Now,
            Value = p
        });

        await log.Create(
        new LogRecord()
        {
            Player = player,
            Message = $"{adminName} -> {manualPointsMessage}",
            Timestamp = DateTime.Now,
            Type = LogRecord.RecordType.PointTransaction
        });

        manualPoints = "";
        manualPointsMessage = "";

        player = players.GetFromBadge(BadgeNumber);

        await js.HideModal("addPoints");
    }

    async Task SumbitMessage()
    {
        if (string.IsNullOrWhiteSpace(logMessage))
        {
            return;
        }

        await log.Create(new LogRecord()
        {
            Type = LogRecord.RecordType.Player,
            Message = logMessage,
            Player = player,
            Timestamp = DateTime.Now
        });

        logMessage = default;

        await js.HideModal("logMessage");
    }

    async Task ResetQuestion(Question question)
    {
        if(player == default || question == default)
        {
            return;
        }
        resetQuestion = question;
        await js.ShowModal("resetQuestion");
    }

    async Task ConfirmResetQuestion()
    {
        if (string.IsNullOrWhiteSpace(resetMessage))
        {
            return;
        }

        if(resetQuestion == default || player == default)
        {
            return;
        }

        if(await points.Reset(player, resetQuestion))
        {
            resetQuestion = default;
            player = players.GetFromBadge(BadgeNumber);
            StateHasChanged();
            await js.HideModal("resetQuestion");
        }
    }
}