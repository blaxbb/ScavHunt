@page "/admin/questions"
@using ScavHunt.Data.Models
@attribute [Authorize]
@inject QuestionAdminService questions
@inject JSInterop js

<Modal id="@EditId">
    @if (editQuestion != null)
    {
        <EditForm id="editQuestionForm" Model="@editQuestion" OnValidSubmit="@SaveQuestion">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-check mb-3">
                <InputText class="form-control" id="vendor" @bind-Value="editQuestion.Vendor" placeholder="Vendor" />
            </div>

            <div class="form-check mb-3">
                <InputText class="form-control" id="text" @bind-Value="editQuestion.Text" placeholder="Question" />
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-auto my-auto">
                            Answers
                        </div>
                        <div class="col-sm-auto">
                            <button type="button" class="btn btn-primary" @onclick="AddAnswer">+</button>
                        </div>
                    </div>
                    @for(int i = 0; i < editQuestion.Answers.Count; i++)
                    {
                        // index required for onchange function call
                        var index = i;
                        var answer = editQuestion.Answers[i];

                        <div class="form-check mb-3">
                            <input type="text" class="form-control" placeholder="Answer" @oninput="@((e)=> UpdateAnswer(index, e.Value.ToString()))" value="@answer"/>
                        </div>
                
                    }
                </div>
            </div>
            <div class="form-check mb-3">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
    
        </EditForm>
    }
</Modal>

<div class="container">
    <div class="row">
        <div class="col-sm-auto">
            <h3>Questions</h3>
        </div>
        <div class="col-sm-auto">
            <button type="button" class="btn btn-primary" @onclick="NewQuestion">New</button>
        </div>
    </div>

    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <td>Short Code</td>
                <td>Vendor</td>
                <td>Text</td>
                <td>Answer Count</td>
                <td></td>
                <td></td>
            </tr>
        </thead>
        @if (All != null)
        {
            <tbody>
                @foreach(var question in All)
                {
                    <tr>
                        <td>@question.ShortCode</td>
                        <td>@question.Vendor</td>
                        <td>@(question.Text.Length > 16 ? question.Text.Substring(0,16) : question.Text)</td>
                        <td>@(question.Answers?.Count ?? 0)</td>
                        <td><button type="button" class="btn btn-primary">Details</button></td>
                        <td><button type="button" class="btn btn-primary" @onclick="(() => EditQuestion(question))">Edit</button></td>
                    </tr>
                }
            </tbody>
        }
    </table>
</div>
@code {
    const string EditId = "EditQuestionModal";

    List<Question> All { get; set; }

    Question editQuestion { get; set; }

    protected override async Task OnInitializedAsync()
    {
        All = await questions.All();
    }

    async Task NewQuestion()
    {
        editQuestion = new Question();
        editQuestion.Answers.Add("");
        await js.ShowModal(EditId);
    }

    async Task EditQuestion(Question question)
    {
        editQuestion = new Question()
        {
            Id = question.Id,
            ShortCode = question.ShortCode,
            Vendor = question.Vendor,
            Text = question.Text,
            Answers = question.Answers.ToList()
        };

        await js.ShowModal(EditId);
    }

    async Task SaveQuestion()
    {
        if(editQuestion != null)
        {
            editQuestion.Answers.RemoveAll(q => string.IsNullOrWhiteSpace(q));
            if(string.IsNullOrWhiteSpace(editQuestion.ShortCode))
            {
                await questions.Add(editQuestion);
            }
            else
            {
                await questions.Update(editQuestion);
            }
        }

        editQuestion = new Question();

        All = await questions.All();
        await js.HideModal(EditId);
    }

    void UpdateAnswer(int index, string value)
    {
        if(editQuestion == null || editQuestion.Answers.Count <= index)
        {
            return;
        }

        editQuestion.Answers[index] = value;
    }

    void AddAnswer()
    {
        if(editQuestion != default)
        {
            editQuestion?.Answers.Add("");
        }
    }
}
