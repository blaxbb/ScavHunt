@page "/admin/accounts/{id}"
@attribute [Authorize(Roles = "admin")]
@using Microsoft.AspNetCore.Identity;
@using ScavHunt.Data.Models;
@using ScavHunt.Services;
@using System.Text.RegularExpressions;
@inject UserManager<ScavhuntUser> userManager;
@inject UserService users;
@inject NavigationManager navManager;

<ScannerModal Id="scannerModal" Title="Scan Badge" Success="ScanSuccess" @ref=scanner />

<div class="container">
    @if (User != null)
    {
        <h3>AccountEdit</h3>
        <form @onsubmit="(async() => await saveAccount())">
            <input class="form-control mb-3" readonly @bind-value="User.Email" />
            <div class="mb-3">
                <label class="form-label">Display Name</label>
                <input class="form-control mb-3" @bind-value="User.DisplayName" />
            </div>
            <div class="mb-3">
                <label class="form-label">Badge</label>
                <div class="row">
                    <div class="col-auto">
                        <button type="button" class="btn btn-interactable"><span class="oi oi-camera-slr" @onclick=ShowBadgeScanner></span></button>
                    </div>
                    <div class="col">
                        <input class="form-control mb-3" @bind-value="User.BadgeId" />
                    </div>
                </div>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" @bind="IsAdmin" id="adminCheckbox">
                <label class="form-check-label" for="adminCheckbox">
                    Is Administrator
                </label>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" @bind="IsPrizeAdmin" id="prizeCheckbox">
                <label class="form-check-label" for="prizeCheckbox">
                    Is Prize Admin
                </label>
            </div>
@*            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" @bind="Is" id="lockCheckbox">
                <label class="form-check-label" for="lockCheckbox">
                    Is Locked
                </label>
            </div>*@
            <button class="btn btn-primary" type="submit">Save</button>
        </form>
    }
</div>

@code {
    [Parameter]
    public string id { get; set; }

    ScavhuntUser User;
    bool IsAdmin { get; set; }
    bool IsPrizeAdmin { get; set; }

    ScannerModal? scanner { get; set; }

    IList<string> roles;

    protected override async Task OnInitializedAsync()
    {
        User = await userManager.FindByIdAsync(id);
        roles = users.GetRolesById(id).ToList();
        if (roles.Contains("admin"))
        {
            IsAdmin = true;
        }
        if(roles.Contains("prize"))
        {
            IsPrizeAdmin = true;
        }

        await base.OnInitializedAsync();
    }

    async Task saveAccount()
    {
        if (IsAdmin && !roles.Contains("admin"))
        {
            users.AddToRole(User, "admin");
        }

        if (!IsAdmin && roles.Contains("admin"))
        {
            users.RemoveFromRole(User, "admin");
        }

        if(IsPrizeAdmin && !roles.Contains("prize"))
        {
            users.AddToRole(User, "prize");
        }
        if(!IsPrizeAdmin && roles.Contains("prize"))
        {
            users.AddToRole(User, "prize");
        }

        await users.Update(User);

        navManager.NavigateTo("/admin/accounts");
    }

    async Task ShowBadgeScanner()
    {
        await scanner.Show();
    }

    async Task ScanSuccess(string text)
    {
        var match = Regex.Match(text, ScavhuntUser.BADGE_REGEX);
        if (match.Success)
        {
            User.BadgeId = text;
            await scanner?.Hide();
        }
    }

}
